<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>å³æ™‚èªéŸ³è¾¨è­˜</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
            margin: 0;
            padding: 0;
            background-color: #2a3849;
        }
    .container {
      max-width: 900px;
    }
    .back-button {
            background-color: #d2d2d3;
            color: rgb(0, 0, 0);
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            display: block;
            margin: 0 auto;
            width: 150px;
            margin-top: 20px;
        }

        .back-button:hover {
            background-color: #d2d2d3;
            transform: scale(1.1);
        }

        .back-button:focus {
            outline: none;
        }

        .simple-button {
        background-color: #d2d2d3;
        color: black;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 6px;
        margin: 5px;
        cursor: pointer;
        }
      /* å°è¦½åˆ—æ¨£å¼ */
      .navbar {
            margin-bottom: 20px;
            background-color: #3d3d3d !important;
        }

        .navbar-light .navbar-nav .nav-link {
            color: white !important;
            /* ä½¿ç”¨ !important å¼·åˆ¶æ‡‰ç”¨æ–‡å­—é¡è‰² */
        }

        .navbar-brand {
            color: #ffffff !important;
        }

        .nav-item .dropdown-menu {
            left: -30px;
            /* èª¿æ•´é€™å€‹æ•¸å€¼ä¾†å¾®èª¿æ°´å¹³ä½ç½® */
            right: auto;
        }

        /* å°èˆªé …ç›®å³å´é¡¯ç¤ºå¸³æˆ¶åç¨± */
        .navbar .navbar-nav {
            margin-left: auto;
            /* ä½¿é¸å–®å³å°é½Š */
        }

        .navbar .navbar-nav .nav-item:last-child {
            margin-left: 15px;
            /* ç‚ºå¸³æˆ¶åç¨±èˆ‡ä¸‹æ‹‰é¸å–®å¢åŠ é–“è· */
        }

        .navbar-nav {
            display: flex;
            justify-content: flex-end;
            /* è®“é¸å–®é …ç›®é å³å°é½Š */
        }

        .account-name {
            font-size: 20px;
            font-weight: bold;
        }

        .nav-link.dropdown-toggle {
            cursor: pointer;
            user-select: none;
            /* ç¦æ­¢é¸å–æ–‡å­— */
        }

    .transcription-box,
    .log-box {
      background: #ffffff;
      padding: 15px;
      border-radius: 5px;
      font-size: 16px;
      line-height: 1.5;
      white-space: pre-wrap;
      color: rgb(0, 0, 0);
    }
    body, h1, h2, h3, h4, h5, h6, p, label, select, option, div, span {
    color: white;
}
  </style>
</head>

<body>
  <div class="container mt-4">
    <h2> å³æ™‚èªéŸ³è½‰æ–‡å­—</h2>
    <hr>

    <div class="form-group">
      <label for="engineSelect">é¸æ“‡è¾¨è­˜å¼•æ“ï¼š</label>
      <select id="engineSelect" class="form-control w-50">
        <option value="google">Google Web Speech</option>
        <option value="whisper">Whisper</option>
      </select>
    </div>

    <div class="form-group">
      <label for="langSelect">èªè¨€é¸æ“‡ï¼š</label>
      <select id="langSelect" class="form-control w-50">
        <option value="zh">ä¸­æ–‡</option>
        <option value="en">è‹±æ–‡</option>
      </select>
    </div>

    <p id="engine-status"></p>

    <div class="button-group">
      <button class="simple-button" onclick="startRecording()">â–¶ï¸ é–‹å§‹éŒ„éŸ³</button>
      <button class="simple-button" onclick="stopRecording()">â¹ï¸ åœæ­¢éŒ„éŸ³</button>
      <button class="simple-button" onclick="clearTranscription()">ğŸ§¹ æ¸…é™¤æ–‡å­—</button>
    </div>

    <br>
    <h4> è½‰éŒ„çµæœï¼š</h4>
    <div id="transcription" class="transcription-box"></div>

    <br>
    <h4> è¨Šæ¯ Logï¼š</h4>
    <div id="log" class="log-box" style="max-height: 150px; overflow-y: auto;"></div>
    <br>
    <button class="simple-button" onclick="downloadTranscription()"> ä¸‹è¼‰æ–‡å­—</button>
    <hr>
    <button class="back-button" onclick="window.history.back()">â†å›ä¸Šä¸€é </button>
  </div>

  <script>
    const socket = io();
    let recognition;
    let lastTranscription = "";

    function startRecording() {
      const engine = document.getElementById("engineSelect").value;
      const engineName = engine === "google" ? "Google Web Speech" : "Whisper";
      document.getElementById("engine-status").innerText = `ä½¿ç”¨ä¸­è¾¨è­˜å¼•æ“ï¼š${engineName}`;

      if (engine === "google") {
        startGoogleSpeechRecognition();
      } else {
        socket.emit("start_recording");
        log("ğŸ“¡ Whisper å¼•æ“å•Ÿå‹•éŒ„éŸ³ä¸­...");
      }
    }

    function stopRecording() {
      const engine = document.getElementById("engineSelect").value;

      if (engine === "google") {
        stopGoogleSpeechRecognition();
      } else {
        socket.emit("stop_recording");
        log("ğŸ›‘ Whisper å¼•æ“å·²åœæ­¢éŒ„éŸ³");
      }
    }

    function startGoogleSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("ğŸš« æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chrome");
        return;
      }

      recognition = new webkitSpeechRecognition();
      recognition.lang = {
        zh: "zh-TW",
        en: "en-US",
        ja: "ja-JP"
      }[document.getElementById("langSelect").value];

      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onstart = function () {
        log("ğŸ™ï¸ é–‹å§‹èªéŸ³è¾¨è­˜ï¼ˆGoogle Web Speechï¼‰...");
      };

      recognition.onresult = function (event) {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
        lastTranscription += transcript + '\n';
        updateTranscriptionDisplay();
        }
        }
                
      };

      recognition.onerror = function (event) {
        log("âŒ è¾¨è­˜éŒ¯èª¤ï¼š" + event.error);
      };

      recognition.onend = function () {
         // è‹¥æ˜¯ç”¨æˆ¶æ²’æœ‰æ‰‹å‹•åœæ­¢ï¼Œå‰‡è‡ªå‹•é‡å•Ÿ
        if (recognition) {
            recognition.start();
            log("ğŸ” Google Speech API è‡ªå‹•é‡å•Ÿè¾¨è­˜ä¸­...");
        }
      };

      recognition.start();
    }

    function stopGoogleSpeechRecognition() {
        if (recognition) {
        recognition.onend = null; // åœæ­¢è‡ªå‹•é‡å•Ÿ
        recognition.stop();
        recognition = null;
        log("ğŸ›‘ å·²åœæ­¢ Google Web Speech è¾¨è­˜");
    }
    }

    function clearTranscription() {
      document.getElementById("transcription").innerText = "";
      document.getElementById("log").innerText = "";
    }

    function updateTranscriptionDisplay() {
    document.getElementById("transcription").innerText = lastTranscription;
    }

    function downloadTranscription() {
    const text = document.getElementById("transcription").innerText;
    if (!text.trim()) {
        alert(" æ²’æœ‰å¯ä¸‹è¼‰çš„è½‰éŒ„æ–‡å­—");
        return;
    }

    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "transcription.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    }

    function log(message) {
      const logElement = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      logElement.innerText += `[${time}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
    }
    
  </script>
</body>

</html>
